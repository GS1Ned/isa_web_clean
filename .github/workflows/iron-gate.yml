name: IRON Gate

on:
  pull_request:
    branches: [main]

jobs:
  iron-gate:
    name: IRON Protocol Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get main branch commit hash
        id: main-hash
        run: |
          git fetch origin main
          MAIN_HASH=$(git rev-parse origin/main )
          echo "hash=$MAIN_HASH" >> $GITHUB_OUTPUT
          echo "Main branch commit: $MAIN_HASH"

      - name: Check Context Acknowledgement
        id: context-check
        run: |
          echo "Checking PR description for Context-Commit-Hash..."
          
          PR_BODY="${{ github.event.pull_request.body }}"
          
          if [[ -z "$PR_BODY" ]]; then
            echo "::error::PR description is empty. IRON Protocol requires a Context Acknowledgement block."
            echo "::error::Please run ./scripts/iron-context.sh and copy the acknowledgement to your PR description."
            exit 1
          fi
          
          if echo "$PR_BODY" | grep -q "Context-Commit-Hash:"; then
            CONTEXT_HASH=$(echo "$PR_BODY" | grep -oP "Context-Commit-Hash:\s*\K[a-f0-9]+")
            echo "Found Context-Commit-Hash: $CONTEXT_HASH"
            echo "context_hash=$CONTEXT_HASH" >> $GITHUB_OUTPUT
          else
            echo "::error::Missing Context-Commit-Hash in PR description."
            echo "::error::IRON Protocol requires explicit context acknowledgement."
            echo "::error::Please run ./scripts/iron-context.sh and copy the acknowledgement to your PR description."
            exit 1
          fi

      - name: Validate Context Freshness
        run: |
          MAIN_HASH="${{ steps.main-hash.outputs.hash }}"
          CONTEXT_HASH="${{ steps.context-check.outputs.context_hash }}"
          
          echo "Main branch hash:    $MAIN_HASH"
          echo "Context hash in PR:  $CONTEXT_HASH"
          
          if git merge-base --is-ancestor "$CONTEXT_HASH" "$MAIN_HASH" 2>/dev/null; then
            echo "✅ Context hash is valid (is ancestor of or equal to main)"
          else
            echo "::warning::Context hash is not an ancestor of main. This may indicate stale context."
            echo "::warning::Consider re-running ./scripts/iron-context.sh to update your context."
          fi
          
          echo "✅ Context validation passed"

      - name: Check Inventory File Not Modified
        run: |
          echo "Checking if isa.inventory.json was modified in this PR..."
          
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          if echo "$CHANGED_FILES" | grep -q "^isa.inventory.json$"; then
            echo "::error::isa.inventory.json was modified in this PR."
            echo "::error::This file is auto-generated and should not be committed."
            echo "::error::Please remove isa.inventory.json from your commit."
            exit 1
          fi
          
          echo "✅ Inventory file check passed"

      - name: IRON Gate Summary
        run: |
          echo "=============================================="
          echo "IRON Gate: All checks passed"
          echo "=============================================="
          echo ""
          echo "✅ Context Acknowledgement: Present"
          echo "✅ Context Freshness: Valid"
          echo "✅ Inventory File: Not modified"
          echo ""
          echo "This PR complies with the IRON Protocol."
