name: Catalogue Checks

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  catalogue-checks:
    name: Catalogue Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Block non-bot edits to generated catalogue artefacts
        shell: bash
        run: |
          set -euo pipefail
          ACTOR="${{ github.actor }}"
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          CHANGED="$(git diff --name-status "$BASE...$HEAD" || true)"

          if [[ "$ACTOR" != "github-actions[bot]" ]]; then
            if printf '%s\n' "$CHANGED" | grep -E '^[AMDR]\s+docs/evidence/(generated/_generated|_generated)/(GS1_EFRAG_CATALOGUE\.(json|csv)|GS1_EFRAG_CATALOGUE_INDEX\.md|CATALOGUE_ENTRYPOINTS_STATUS\.(json|md)|isa_catalogue_latest/|isa_catalogue_runs/)' >/dev/null; then

              echo "::error::Generated catalogue artefacts may only be updated by github-actions[bot] (scheduled refresh)."
              echo "::error::If you changed generator logic, remove generated outputs from this PR and let the scheduled job refresh them."
              exit 1
            fi
          fi
          echo "ok"

      - name: 'IRON gate: "catalogue present + fresh"'
        shell: bash
        env:
          ISA_EVIDENCE_OUT_DIR: docs/evidence/generated/_generated
          ISA_EVIDENCE_SNAPSHOT: '1'
        run: bash scripts/isa-catalogue/iron_gate_catalogue.sh

      - name: Validate GS1/EFRAG catalogue legacy artefacts + required bodies
        shell: bash
        env:
          ISA_EVIDENCE_OUT_DIR: docs/evidence/generated/_generated
          ISA_EVIDENCE_SNAPSHOT: '1'
        run: python3 scripts/validate_gs1_efrag_catalogue.py
